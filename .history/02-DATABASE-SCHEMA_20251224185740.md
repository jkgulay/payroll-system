# Database Schema Design - PostgreSQL

## Schema Overview

This schema supports:

- Multi-location, multi-department organization
- Multiple employee types
- Semi-monthly payroll
- Philippine government compliance (SSS, PhilHealth, Pag-IBIG, Tax)
- Audit logging
- Historical data tracking

---

## Entity Relationship Diagram

```
┌────────────────┐
│     Users      │
└────────┬───────┘
         │
         │ 1:1
         ▼
┌────────────────┐        ┌─────────────────┐
│   Employees    │───────▶│   Departments   │
└────────┬───────┘   M:1  └─────────────────┘
         │
         │ 1:1            ┌─────────────────┐
         ├───────────────▶│   Locations     │
         │           M:1  └─────────────────┘
         │
         │ 1:M
         ├────────┬───────┬──────────┬───────────┐
         │        │       │          │           │
         ▼        ▼       ▼          ▼           ▼
    ┌────────┐ ┌────┐ ┌──────┐  ┌──────┐  ┌──────────┐
    │Payroll │ │Att.│ │Loans │  │Allow.│  │Documents │
    └────┬───┘ └────┘ └──────┘  └──────┘  └──────────┘
         │
         │ 1:M
         ▼
    ┌──────────────┐
    │Payroll Items │
    └──────────────┘
```

---

## Core Tables

### 1. users

Primary authentication table for all system users.

```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    email_verified_at TIMESTAMP,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL, -- 'admin', 'accountant', 'employee'
    is_active BOOLEAN DEFAULT true,
    last_login_at TIMESTAMP,
    two_factor_secret TEXT,
    two_factor_enabled BOOLEAN DEFAULT false,
    remember_token VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_is_active ON users(is_active);
```

---

### 2. departments

Company departments/divisions.

```sql
CREATE TABLE departments (
    id BIGSERIAL PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    head_employee_id BIGINT, -- Department head
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

CREATE INDEX idx_departments_code ON departments(code);
CREATE INDEX idx_departments_is_active ON departments(is_active);
```

---

### 3. locations

Physical work locations.

```sql
CREATE TABLE locations (
    id BIGSERIAL PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    address TEXT,
    city VARCHAR(100),
    province VARCHAR(100),
    postal_code VARCHAR(10),
    contact_number VARCHAR(20),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

CREATE INDEX idx_locations_code ON locations(code);
CREATE INDEX idx_locations_is_active ON locations(is_active);
```

---

### 4. employees

Core employee information.

```sql
CREATE TABLE employees (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT UNIQUE, -- Nullable for non-system users
    employee_number VARCHAR(20) UNIQUE NOT NULL,

    -- Personal Information
    first_name VARCHAR(100) NOT NULL,
    middle_name VARCHAR(100),
    last_name VARCHAR(100) NOT NULL,
    suffix VARCHAR(10), -- Jr., Sr., III
    date_of_birth DATE NOT NULL,
    gender VARCHAR(10), -- 'male', 'female', 'other'
    civil_status VARCHAR(20), -- 'single', 'married', 'widowed', 'separated'
    nationality VARCHAR(50) DEFAULT 'Filipino',

    -- Contact Information
    email VARCHAR(255),
    mobile_number VARCHAR(20),
    phone_number VARCHAR(20),

    -- Address
    address_line1 VARCHAR(255),
    address_line2 VARCHAR(255),
    city VARCHAR(100),
    province VARCHAR(100),
    postal_code VARCHAR(10),

    -- Emergency Contact
    emergency_contact_name VARCHAR(255),
    emergency_contact_relationship VARCHAR(50),
    emergency_contact_number VARCHAR(20),

    -- Employment Details
    department_id BIGINT NOT NULL,
    location_id BIGINT NOT NULL,
    position VARCHAR(100) NOT NULL,
    employment_type VARCHAR(20) NOT NULL, -- 'regular', 'contractual', 'part_time'
    employment_status VARCHAR(20) DEFAULT 'active', -- 'active', 'resigned', 'terminated', 'retired'
    date_hired DATE NOT NULL,
    date_regularized DATE,
    date_separated DATE,

    -- Salary Information
    salary_type VARCHAR(20) DEFAULT 'daily', -- 'daily', 'monthly', 'hourly'
    basic_salary DECIMAL(12,2) NOT NULL, -- Daily rate for daily-paid

    -- Government IDs
    sss_number VARCHAR(20),
    philhealth_number VARCHAR(20),
    pagibig_number VARCHAR(20),
    tin_number VARCHAR(20),

    -- Banking
    bank_name VARCHAR(100),
    bank_account_number VARCHAR(50),

    -- Profile
    profile_photo VARCHAR(255),

    -- System Fields
    is_active BOOLEAN DEFAULT true,
    created_by BIGINT,
    updated_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (department_id) REFERENCES departments(id),
    FOREIGN KEY (location_id) REFERENCES locations(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (updated_by) REFERENCES users(id)
);

CREATE INDEX idx_employees_user_id ON employees(user_id);
CREATE INDEX idx_employees_employee_number ON employees(employee_number);
CREATE INDEX idx_employees_department_id ON employees(department_id);
CREATE INDEX idx_employees_location_id ON employees(location_id);
CREATE INDEX idx_employees_employment_status ON employees(employment_status);
CREATE INDEX idx_employees_employment_type ON employees(employment_type);
CREATE INDEX idx_employees_last_name ON employees(last_name);
CREATE INDEX idx_employees_is_active ON employees(is_active);
```

---

### 5. attendance

Daily attendance records.

```sql
CREATE TABLE attendance (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL,
    attendance_date DATE NOT NULL,

    -- Time Records
    time_in TIME,
    time_out TIME,
    break_start TIME,
    break_end TIME,

    -- Calculated Hours
    regular_hours DECIMAL(5,2) DEFAULT 0,
    overtime_hours DECIMAL(5,2) DEFAULT 0,
    undertime_hours DECIMAL(5,2) DEFAULT 0,
    late_hours DECIMAL(5,2) DEFAULT 0,

    -- Status
    status VARCHAR(20) DEFAULT 'present', -- 'present', 'absent', 'leave', 'holiday', 'rest_day'
    is_holiday BOOLEAN DEFAULT false,
    holiday_type VARCHAR(20), -- 'regular', 'special_non_working'

    -- Manual Entry
    is_manual_entry BOOLEAN DEFAULT false,
    manual_reason TEXT,

    -- Corrections
    is_edited BOOLEAN DEFAULT false,
    edit_reason TEXT,
    edited_by BIGINT,
    edited_at TIMESTAMP,

    -- Approval
    approval_status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'approved', 'rejected'
    approved_by BIGINT,
    approved_at TIMESTAMP,
    rejection_reason TEXT,

    -- System Fields
    created_by BIGINT,
    updated_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,

    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    FOREIGN KEY (edited_by) REFERENCES users(id),
    FOREIGN KEY (approved_by) REFERENCES users(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (updated_by) REFERENCES users(id),

    UNIQUE(employee_id, attendance_date)
);

CREATE INDEX idx_attendance_employee_id ON attendance(employee_id);
CREATE INDEX idx_attendance_date ON attendance(attendance_date);
CREATE INDEX idx_attendance_status ON attendance(status);
CREATE INDEX idx_attendance_approval_status ON attendance(approval_status);
CREATE INDEX idx_attendance_employee_date ON attendance(employee_id, attendance_date);
```

---

### 6. attendance_corrections

Employee attendance correction requests.

```sql
CREATE TABLE attendance_corrections (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL,
    attendance_id BIGINT,
    attendance_date DATE NOT NULL,

    -- Original Values
    original_time_in TIME,
    original_time_out TIME,
    original_status VARCHAR(20),

    -- Requested Changes
    requested_time_in TIME,
    requested_time_out TIME,
    requested_status VARCHAR(20),
    reason TEXT NOT NULL,
    supporting_document VARCHAR(255),

    -- Approval
    status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'approved', 'rejected'
    reviewed_by BIGINT,
    reviewed_at TIMESTAMP,
    review_notes TEXT,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    FOREIGN KEY (attendance_id) REFERENCES attendance(id) ON DELETE SET NULL,
    FOREIGN KEY (reviewed_by) REFERENCES users(id)
);

CREATE INDEX idx_attendance_corrections_employee ON attendance_corrections(employee_id);
CREATE INDEX idx_attendance_corrections_status ON attendance_corrections(status);
CREATE INDEX idx_attendance_corrections_date ON attendance_corrections(attendance_date);
```

---

### 7. payroll

Payroll period and processing information.

```sql
CREATE TABLE payroll (
    id BIGSERIAL PRIMARY KEY,
    payroll_number VARCHAR(50) UNIQUE NOT NULL,

    -- Period Information
    period_type VARCHAR(20) NOT NULL DEFAULT 'semi_monthly', -- 'semi_monthly', 'monthly'
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    payment_date DATE NOT NULL,

    -- Period Identifier (1st or 2nd half)
    pay_period_number INT NOT NULL, -- 1 for 1st half, 2 for 2nd half
    month INT NOT NULL,
    year INT NOT NULL,

    -- Processing Status
    status VARCHAR(20) DEFAULT 'draft', -- 'draft', 'processing', 'approved', 'paid', 'cancelled'

    -- Totals (computed from payroll_items)
    total_gross_pay DECIMAL(15,2) DEFAULT 0,
    total_deductions DECIMAL(15,2) DEFAULT 0,
    total_net_pay DECIMAL(15,2) DEFAULT 0,

    -- Workflow
    prepared_by BIGINT,
    prepared_at TIMESTAMP,
    approved_by BIGINT,
    approved_at TIMESTAMP,
    paid_by BIGINT,
    paid_at TIMESTAMP,

    -- Notes
    notes TEXT,

    -- System Fields
    created_by BIGINT,
    updated_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,

    FOREIGN KEY (prepared_by) REFERENCES users(id),
    FOREIGN KEY (approved_by) REFERENCES users(id),
    FOREIGN KEY (paid_by) REFERENCES users(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (updated_by) REFERENCES users(id),

    UNIQUE(year, month, pay_period_number)
);

CREATE INDEX idx_payroll_number ON payroll(payroll_number);
CREATE INDEX idx_payroll_status ON payroll(status);
CREATE INDEX idx_payroll_period ON payroll(year, month, pay_period_number);
CREATE INDEX idx_payroll_payment_date ON payroll(payment_date);
```

---

### 8. payroll_items

Individual employee payroll entries.

```sql
CREATE TABLE payroll_items (
    id BIGSERIAL PRIMARY KEY,
    payroll_id BIGINT NOT NULL,
    employee_id BIGINT NOT NULL,

    -- Basic Pay
    basic_rate DECIMAL(12,2) NOT NULL, -- Daily rate
    days_worked DECIMAL(5,2) DEFAULT 0,
    basic_pay DECIMAL(12,2) DEFAULT 0,

    -- Additional Pay
    overtime_hours DECIMAL(5,2) DEFAULT 0,
    overtime_pay DECIMAL(12,2) DEFAULT 0,
    holiday_pay DECIMAL(12,2) DEFAULT 0,
    night_differential DECIMAL(12,2) DEFAULT 0,

    -- Adjustments
    adjustments DECIMAL(12,2) DEFAULT 0, -- Positive or negative
    adjustment_notes TEXT,

    -- Allowances (from employee_allowances)
    total_allowances DECIMAL(12,2) DEFAULT 0,

    -- Bonuses and Incentives
    total_bonuses DECIMAL(12,2) DEFAULT 0,

    -- Gross Pay
    gross_pay DECIMAL(12,2) NOT NULL,

    -- Government Deductions
    sss_contribution DECIMAL(12,2) DEFAULT 0,
    philhealth_contribution DECIMAL(12,2) DEFAULT 0,
    pagibig_contribution DECIMAL(12,2) DEFAULT 0,
    withholding_tax DECIMAL(12,2) DEFAULT 0,

    -- Other Deductions (from employee_deductions)
    total_other_deductions DECIMAL(12,2) DEFAULT 0,

    -- Loan Deductions (from employee_loans)
    total_loan_deductions DECIMAL(12,2) DEFAULT 0,

    -- Total Deductions
    total_deductions DECIMAL(12,2) NOT NULL,

    -- Net Pay
    net_pay DECIMAL(12,2) NOT NULL,

    -- Payslip
    payslip_generated BOOLEAN DEFAULT false,
    payslip_file_path VARCHAR(255),

    -- System Fields
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (payroll_id) REFERENCES payroll(id) ON DELETE CASCADE,
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,

    UNIQUE(payroll_id, employee_id)
);

CREATE INDEX idx_payroll_items_payroll_id ON payroll_items(payroll_id);
CREATE INDEX idx_payroll_items_employee_id ON payroll_items(employee_id);
CREATE INDEX idx_payroll_items_payroll_employee ON payroll_items(payroll_id, employee_id);
```

---

### 9. payroll_item_details

Detailed breakdown of payroll items (earnings and deductions).

```sql
CREATE TABLE payroll_item_details (
    id BIGSERIAL PRIMARY KEY,
    payroll_item_id BIGINT NOT NULL,

    type VARCHAR(20) NOT NULL, -- 'earning', 'deduction'
    category VARCHAR(50) NOT NULL, -- 'basic', 'overtime', 'allowance', 'sss', 'loan', etc.
    description VARCHAR(255) NOT NULL,
    amount DECIMAL(12,2) NOT NULL,

    -- Reference IDs
    reference_id BIGINT, -- ID of related record (allowance_id, loan_id, etc.)
    reference_type VARCHAR(50), -- 'allowance', 'loan', 'deduction', etc.

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (payroll_item_id) REFERENCES payroll_items(id) ON DELETE CASCADE
);

CREATE INDEX idx_payroll_item_details_item ON payroll_item_details(payroll_item_id);
CREATE INDEX idx_payroll_item_details_type ON payroll_item_details(type);
```

---

## Employee Benefits & Deductions

### 10. employee_allowances

Recurring or one-time allowances.

```sql
CREATE TABLE employee_allowances (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL,

    allowance_type VARCHAR(50) NOT NULL, -- 'transportation', 'meal', 'housing', 'communication', 'other'
    description VARCHAR(255),
    amount DECIMAL(12,2) NOT NULL,

    frequency VARCHAR(20) NOT NULL, -- 'daily', 'monthly', 'one_time'

    -- Effectivity
    effective_from DATE NOT NULL,
    effective_to DATE,

    is_taxable BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,

    created_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,

    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE INDEX idx_employee_allowances_employee ON employee_allowances(employee_id);
CREATE INDEX idx_employee_allowances_type ON employee_allowances(allowance_type);
CREATE INDEX idx_employee_allowances_active ON employee_allowances(is_active);
```

---

### 11. employee_bonuses

Bonuses and incentives.

```sql
CREATE TABLE employee_bonuses (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL,

    bonus_type VARCHAR(50) NOT NULL, -- 'performance', '13th_month', 'anniversary', 'referral', 'other'
    description VARCHAR(255) NOT NULL,
    amount DECIMAL(12,2) NOT NULL,

    -- Payroll Association
    payroll_id BIGINT, -- Which payroll period to include

    is_taxable BOOLEAN DEFAULT true,

    -- Approval
    status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'approved', 'paid'
    approved_by BIGINT,
    approved_at TIMESTAMP,

    created_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    FOREIGN KEY (payroll_id) REFERENCES payroll(id) ON DELETE SET NULL,
    FOREIGN KEY (approved_by) REFERENCES users(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE INDEX idx_employee_bonuses_employee ON employee_bonuses(employee_id);
CREATE INDEX idx_employee_bonuses_payroll ON employee_bonuses(payroll_id);
CREATE INDEX idx_employee_bonuses_status ON employee_bonuses(status);
```

---

### 12. employee_deductions

Custom recurring deductions.

```sql
CREATE TABLE employee_deductions (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL,

    deduction_type VARCHAR(50) NOT NULL, -- 'ppe', 'uniform', 'cash_advance', 'insurance', 'cooperative', 'other'
    description VARCHAR(255) NOT NULL,
    amount DECIMAL(12,2) NOT NULL,

    frequency VARCHAR(20) NOT NULL, -- 'one_time', 'monthly', 'semi_monthly'

    -- For installment deductions
    total_amount DECIMAL(12,2),
    remaining_balance DECIMAL(12,2),

    -- Effectivity
    start_date DATE NOT NULL,
    end_date DATE,

    is_active BOOLEAN DEFAULT true,

    created_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,

    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE INDEX idx_employee_deductions_employee ON employee_deductions(employee_id);
CREATE INDEX idx_employee_deductions_type ON employee_deductions(deduction_type);
CREATE INDEX idx_employee_deductions_active ON employee_deductions(is_active);
```

---

### 13. employee_loans

Employee loans with amortization.

```sql
CREATE TABLE employee_loans (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL,

    loan_type VARCHAR(50) NOT NULL, -- 'sss', 'pagibig', 'company', 'emergency', 'other'
    description TEXT,

    principal_amount DECIMAL(12,2) NOT NULL,
    interest_rate DECIMAL(5,2) DEFAULT 0, -- Percentage
    total_amount DECIMAL(12,2) NOT NULL, -- Principal + Interest

    monthly_amortization DECIMAL(12,2) NOT NULL,
    number_of_payments INT NOT NULL,
    payments_made INT DEFAULT 0,
    remaining_balance DECIMAL(12,2) NOT NULL,

    start_date DATE NOT NULL,
    end_date DATE,

    status VARCHAR(20) DEFAULT 'active', -- 'active', 'paid', 'cancelled'

    approved_by BIGINT,
    approved_at TIMESTAMP,

    created_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,

    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    FOREIGN KEY (approved_by) REFERENCES users(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE INDEX idx_employee_loans_employee ON employee_loans(employee_id);
CREATE INDEX idx_employee_loans_status ON employee_loans(status);
CREATE INDEX idx_employee_loans_type ON employee_loans(loan_type);
```

---

### 14. loan_payments

Track individual loan payment deductions.

```sql
CREATE TABLE loan_payments (
    id BIGSERIAL PRIMARY KEY,
    loan_id BIGINT NOT NULL,
    payroll_item_id BIGINT,

    payment_date DATE NOT NULL,
    amount_paid DECIMAL(12,2) NOT NULL,
    balance_after_payment DECIMAL(12,2) NOT NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (loan_id) REFERENCES employee_loans(id) ON DELETE CASCADE,
    FOREIGN KEY (payroll_item_id) REFERENCES payroll_items(id) ON DELETE SET NULL
);

CREATE INDEX idx_loan_payments_loan ON loan_payments(loan_id);
CREATE INDEX idx_loan_payments_payroll_item ON loan_payments(payroll_item_id);
```

---

## Government Compliance

### 15. sss_contribution_table

SSS contribution rates (updated annually).

```sql
CREATE TABLE sss_contribution_table (
    id BIGSERIAL PRIMARY KEY,

    min_range DECIMAL(12,2) NOT NULL,
    max_range DECIMAL(12,2) NOT NULL,

    employee_share DECIMAL(12,2) NOT NULL,
    employer_share DECIMAL(12,2) NOT NULL,
    total_contribution DECIMAL(12,2) NOT NULL,

    effective_from DATE NOT NULL,
    effective_to DATE,

    is_active BOOLEAN DEFAULT true,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sss_table_range ON sss_contribution_table(min_range, max_range);
CREATE INDEX idx_sss_table_active ON sss_contribution_table(is_active);
```

---

### 16. philhealth_contribution_table

PhilHealth contribution rates.

```sql
CREATE TABLE philhealth_contribution_table (
    id BIGSERIAL PRIMARY KEY,

    min_range DECIMAL(12,2) NOT NULL,
    max_range DECIMAL(12,2) NOT NULL,

    contribution_rate DECIMAL(5,4) NOT NULL, -- e.g., 0.04 for 4%
    employee_share DECIMAL(12,2) NOT NULL,
    employer_share DECIMAL(12,2) NOT NULL,
    total_contribution DECIMAL(12,2) NOT NULL,

    effective_from DATE NOT NULL,
    effective_to DATE,

    is_active BOOLEAN DEFAULT true,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_philhealth_table_range ON philhealth_contribution_table(min_range, max_range);
CREATE INDEX idx_philhealth_table_active ON philhealth_contribution_table(is_active);
```

---

### 17. pagibig_contribution_table

Pag-IBIG contribution rates.

```sql
CREATE TABLE pagibig_contribution_table (
    id BIGSERIAL PRIMARY KEY,

    min_range DECIMAL(12,2) NOT NULL,
    max_range DECIMAL(12,2) NOT NULL,

    employee_rate DECIMAL(5,4) NOT NULL,
    employer_rate DECIMAL(5,4) NOT NULL,

    effective_from DATE NOT NULL,
    effective_to DATE,

    is_active BOOLEAN DEFAULT true,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_pagibig_table_range ON pagibig_contribution_table(min_range, max_range);
CREATE INDEX idx_pagibig_table_active ON pagibig_contribution_table(is_active);
```

---

### 18. tax_withholding_table

BIR Withholding Tax table.

```sql
CREATE TABLE tax_withholding_table (
    id BIGSERIAL PRIMARY KEY,

    compensation_level VARCHAR(20) NOT NULL, -- 'daily', 'weekly', 'semi_monthly', 'monthly'
    min_range DECIMAL(12,2) NOT NULL,
    max_range DECIMAL(12,2),

    base_tax DECIMAL(12,2) NOT NULL,
    excess_rate DECIMAL(5,4) NOT NULL, -- e.g., 0.20 for 20%
    excess_over DECIMAL(12,2) NOT NULL,

    effective_from DATE NOT NULL,
    effective_to DATE,

    is_active BOOLEAN DEFAULT true,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tax_table_level ON tax_withholding_table(compensation_level);
CREATE INDEX idx_tax_table_range ON tax_withholding_table(min_range, max_range);
CREATE INDEX idx_tax_table_active ON tax_withholding_table(is_active);
```

---

## Recruitment Module

### 19. applicants

Job applicants/candidates.

```sql
CREATE TABLE applicants (
    id BIGSERIAL PRIMARY KEY,

    -- Personal Information
    first_name VARCHAR(100) NOT NULL,
    middle_name VARCHAR(100),
    last_name VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL,
    mobile_number VARCHAR(20) NOT NULL,

    -- Application Details
    position_applied VARCHAR(100) NOT NULL,
    department_id BIGINT,
    location_id BIGINT,

    expected_salary DECIMAL(12,2),
    available_start_date DATE,

    -- Documents
    resume_file_path VARCHAR(255),
    cover_letter TEXT,

    -- Status
    application_status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'reviewing', 'approved', 'rejected', 'hired'

    -- Interview
    interview_date TIMESTAMP,
    interview_notes TEXT,

    -- Decision
    reviewed_by BIGINT,
    reviewed_at TIMESTAMP,
    rejection_reason TEXT,

    -- Conversion to Employee
    employee_id BIGINT, -- Set when converted to employee

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,

    FOREIGN KEY (department_id) REFERENCES departments(id),
    FOREIGN KEY (location_id) REFERENCES locations(id),
    FOREIGN KEY (reviewed_by) REFERENCES users(id),
    FOREIGN KEY (employee_id) REFERENCES employees(id)
);

CREATE INDEX idx_applicants_status ON applicants(application_status);
CREATE INDEX idx_applicants_position ON applicants(position_applied);
CREATE INDEX idx_applicants_department ON applicants(department_id);
```

---

### 20. applicant_documents

Additional documents for applicants.

```sql
CREATE TABLE applicant_documents (
    id BIGSERIAL PRIMARY KEY,
    applicant_id BIGINT NOT NULL,

    document_type VARCHAR(50) NOT NULL, -- 'resume', 'id', 'diploma', 'certificate', 'other'
    document_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(255) NOT NULL,
    file_size INT,

    uploaded_by BIGINT,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (applicant_id) REFERENCES applicants(id) ON DELETE CASCADE,
    FOREIGN KEY (uploaded_by) REFERENCES users(id)
);

CREATE INDEX idx_applicant_documents_applicant ON applicant_documents(applicant_id);
```

---

## System & Configuration

### 21. holidays

Philippine holidays and company-specific non-working days.

```sql
CREATE TABLE holidays (
    id BIGSERIAL PRIMARY KEY,

    name VARCHAR(255) NOT NULL,
    date DATE NOT NULL,
    holiday_type VARCHAR(30) NOT NULL, -- 'regular', 'special_non_working', 'company'

    -- Pay Multiplier
    pay_multiplier DECIMAL(5,2) DEFAULT 1.0, -- e.g., 2.0 for double pay

    is_recurring BOOLEAN DEFAULT false, -- For annual holidays like Christmas

    location_id BIGINT, -- Null for nationwide

    is_active BOOLEAN DEFAULT true,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,

    FOREIGN KEY (location_id) REFERENCES locations(id)
);

CREATE INDEX idx_holidays_date ON holidays(date);
CREATE INDEX idx_holidays_type ON holidays(holiday_type);
CREATE INDEX idx_holidays_location ON holidays(location_id);
```

---

### 22. company_settings

Global system settings.

```sql
CREATE TABLE company_settings (
    id BIGSERIAL PRIMARY KEY,

    -- Company Information
    company_name VARCHAR(255) NOT NULL,
    company_address TEXT,
    company_tin VARCHAR(20),
    company_sss VARCHAR(20),
    company_philhealth VARCHAR(20),
    company_pagibig VARCHAR(20),
    company_logo VARCHAR(255),

    -- Payroll Settings
    payroll_frequency VARCHAR(20) DEFAULT 'semi_monthly',
    default_working_hours_per_day DECIMAL(4,2) DEFAULT 8.00,
    overtime_rate_multiplier DECIMAL(3,2) DEFAULT 1.25,
    night_differential_rate DECIMAL(3,2) DEFAULT 0.10,

    -- Cut-off Settings
    first_cutoff_start INT DEFAULT 1, -- Day of month
    first_cutoff_end INT DEFAULT 15,
    second_cutoff_start INT DEFAULT 16,
    second_cutoff_end INT DEFAULT 0, -- 0 = end of month

    -- Tax Settings
    apply_minimum_wage_exemption BOOLEAN DEFAULT false,
    minimum_wage_amount DECIMAL(12,2),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Insert default settings
INSERT INTO company_settings (company_name) VALUES ('Your Company Name');
```

---

### 23. audit_logs

System audit trail for all critical operations.

```sql
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,

    user_id BIGINT,
    action VARCHAR(50) NOT NULL, -- 'create', 'update', 'delete', 'approve', 'reject'
    entity_type VARCHAR(50) NOT NULL, -- 'employee', 'payroll', 'attendance', etc.
    entity_id BIGINT NOT NULL,

    -- Changes
    old_values JSONB,
    new_values JSONB,

    ip_address VARCHAR(45),
    user_agent TEXT,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_logs_user ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_entity ON audit_logs(entity_type, entity_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_created ON audit_logs(created_at);
```

---

### 24. system_notifications

In-app notifications.

```sql
CREATE TABLE system_notifications (
    id BIGSERIAL PRIMARY KEY,

    user_id BIGINT NOT NULL,

    type VARCHAR(50) NOT NULL, -- 'payroll_approved', 'attendance_correction', 'loan_approved', etc.
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,

    -- Reference
    reference_type VARCHAR(50),
    reference_id BIGINT,

    is_read BOOLEAN DEFAULT false,
    read_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX idx_notifications_user ON system_notifications(user_id);
CREATE INDEX idx_notifications_is_read ON system_notifications(is_read);
CREATE INDEX idx_notifications_created ON system_notifications(created_at);
```

---

### 25. employee_documents

Employee-related documents (201 files).

```sql
CREATE TABLE employee_documents (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL,

    document_type VARCHAR(50) NOT NULL, -- 'contract', 'nbi', 'medical', 'id', 'certificate', 'other'
    document_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(255) NOT NULL,
    file_size INT,

    expiry_date DATE, -- For documents that expire

    uploaded_by BIGINT,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    FOREIGN KEY (uploaded_by) REFERENCES users(id)
);

CREATE INDEX idx_employee_documents_employee ON employee_documents(employee_id);
CREATE INDEX idx_employee_documents_type ON employee_documents(document_type);
```

---

## Database Views (for Reporting)

### View: employee_summary

Quick employee overview with current status.

```sql
CREATE VIEW employee_summary AS
SELECT
    e.id,
    e.employee_number,
    CONCAT(e.first_name, ' ', e.last_name) as full_name,
    e.position,
    d.name as department_name,
    l.name as location_name,
    e.employment_type,
    e.employment_status,
    e.basic_salary,
    e.date_hired,
    e.is_active
FROM employees e
LEFT JOIN departments d ON e.department_id = d.id
LEFT JOIN locations l ON e.location_id = l.id
WHERE e.deleted_at IS NULL;
```

### View: payroll_summary

Payroll totals by period.

```sql
CREATE VIEW payroll_summary AS
SELECT
    p.id as payroll_id,
    p.payroll_number,
    p.year,
    p.month,
    p.pay_period_number,
    p.period_start,
    p.period_end,
    p.payment_date,
    p.status,
    COUNT(pi.id) as employee_count,
    SUM(pi.gross_pay) as total_gross,
    SUM(pi.total_deductions) as total_deductions,
    SUM(pi.net_pay) as total_net
FROM payroll p
LEFT JOIN payroll_items pi ON p.id = pi.payroll_id
GROUP BY p.id;
```

---

## Indexes Summary

All tables include appropriate indexes for:

- Primary keys (automatic)
- Foreign keys
- Frequently queried columns
- Composite indexes for common query patterns
- Unique constraints where applicable

---

## Data Integrity Rules

1. **Soft Deletes**: Use `deleted_at` for employees, departments, locations
2. **Cascading Deletes**: Attendance, payroll_items cascade on employee delete
3. **Prevent Orphans**: Foreign key constraints with appropriate actions
4. **Audit Trail**: All critical tables have `created_by`, `updated_by`, timestamps
5. **Unique Constraints**: Employee numbers, payroll numbers, etc.

---

## Migration Notes

For importing existing Excel data:

1. Import employees first
2. Then departments and locations (if not already exists)
3. Import historical attendance
4. Import historical payroll (create archived payroll records)
5. Set up contribution tables (SSS, PhilHealth, etc.)
6. Import active loans and deductions

---

## Next Steps

See `05-PAYROLL-COMPUTATION.md` for detailed computation logic using these tables.
